<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | Book Recommendation</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/styles.css') }}">
</head>
<body>
    <div class="container">
        <h1>Book Recommendation API</h1>
        <h2 style='text-align:center'>Welcome, {{ user.username }}</h2>

        <div class="profile-info">
            <h3>Profile Information</h3>
            <p><strong>Username:</strong> {{ user.username }}</p>
            <p><strong>User ID:</strong> {{ user.id }}</p>
            <p><strong>Email:</strong> {{ user.email }}</p>
            <p><strong>Age:</strong> {{ user.age }}</p>
            <p><strong>Country:</strong> {{ user.country }}</p>
            {% if user.favorite_subjects %}
            <h4>Your Favorite Subjects</h4>
            <div class="subject-list">
                {% for subj in user.favorite_subjects %}
                    <div class="subject-pill">{{ subj }}</div>
                {% endfor %}
            </div>
            {% endif %}

        </div>

        <h3>User-Based Recommendations</h3>
        <button id="recommendButton">Get Recommendations</button>
        <div id="recommendations" style="display: none"></div>
        <div style="text-align: center; margin-top: 10px;">
            <button id="prevButton" style="display: none; width: auto;">Previous</button>
            <button id="nextButton" style="display: none; width: auto;">Next</button>
        </div>
    </div>

    <script>
        let allRecommendations = [];
        let offset = 0;
        const limit = 30;

        function renderPage() {
            const pageRecs = allRecommendations.slice(offset, offset + limit);

            if (pageRecs.length === 0) return;

            const html = pageRecs.map(book => `
                <a href="/book/${book.item_idx}">
                    <div class="book-card">
                        <img src="${book.cover_id 
                            ? `https://covers.openlibrary.org/b/id/${book.cover_id}-M.jpg`
                            : 'https://via.placeholder.com/150x220?text=No+Cover'}"
                            alt="Cover for ${book.title}">
                        <h3>${book.title}</h3>
                        ${book.author ? `<p><strong>Author:</strong> ${book.author}</p>` : ''}
                        ${book.year ? `<p><strong>Year:</strong> ${book.year}</p>` : ''}
                        ${book.isbn ? `<p><strong>ISBN:</strong> ${book.isbn}</p>` : ''}
                    </div>
                </a>
            `).join("");

            const container = document.getElementById('recommendations');
            container.innerHTML = `<div class="book-grid">${html}</div>`;
            container.style.display = 'block';

            // Button logic
            document.getElementById('prevButton').style.display = offset > 0 ? 'inline-block' : 'none';
            document.getElementById('nextButton').style.display = (offset + limit < allRecommendations.length) ? 'inline-block' : 'none';

            // Scroll to top of recommendation section
            container.scrollIntoView({ behavior: 'smooth' });
        }

        document.getElementById('recommendButton').onclick = async () => {
            offset = 0;
            let user_id = '{{ user.id }}'.trim();
            const response = await fetch(`/profile/recommend?user=${encodeURIComponent(user_id)}&top_n=100`);
            const data = await response.json();

            if (response.ok) {
                allRecommendations = data;
                renderPage();
                document.getElementById('recommendButton').style.display = 'none';
            } else {
                document.getElementById('recommendations').innerHTML = `<p style='color: red;'>Error: ${data.detail}</p>`;
                document.getElementById('recommendations').style.display = 'block';
            }
        };

        document.getElementById('nextButton').onclick = () => {
            offset += limit;
            renderPage();
        };

        document.getElementById('prevButton').onclick = () => {
            offset = Math.max(0, offset - limit);
            renderPage();
        };
    </script>

</body>
</html>
